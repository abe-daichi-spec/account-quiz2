<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å‹˜å®šç§‘ç›® åˆ†é¡ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
  <style>
    :root{
      --border:#ddd;
      --border2:#ccc;
      --text-muted:#666;
      --ok:#0a7;
      --ng:#c33;
      --warn:#b60;
      --radius:14px;

      /* è‰²åˆ†ã‘ */
      --asset-bg: #eef6ff;   --asset-bd:#b7d7ff;
      --liab-bg:  #fff2f2;   --liab-bd:#ffc2c2;
      --equity-bg:#f3efff;   --equity-bd:#d2c6ff;
      --exp-bg:   #fff7e6;   --exp-bd:#ffd08a;
      --rev-bg:   #effff4;   --rev-bd:#b7f0c6;
      --other-bg: #f5f5f5;   --other-bd:#d9d9d9;
    }

    body { font-family: sans-serif; max-width: 920px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
    .muted { color: var(--text-muted); font-size: 14px; }
    .big { font-size: 30px; font-weight: 800; margin: 10px 0 14px; line-height:1.2; }
    .ok { color: var(--ok); font-weight: 900; }
    .ng { color: var(--ng); font-weight: 900; }
    .warn { color: var(--warn); font-weight: 900; }
    .small { font-size: 12px; color: var(--text-muted); }
    .pill { display:inline-block; padding:4px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:#444; }

    .toolbar { display:flex; flex-wrap:wrap; gap:10px 14px; align-items:center; margin: 12px 0 8px; }
    label { user-select:none; }
    select { padding: 10px 10px; border-radius: 12px; border: 1px solid var(--border2); }
    input[type="checkbox"] { transform: scale(1.15); }

    button { border-radius: 14px; border: 1px solid var(--border2); background: #fff; cursor: pointer; }
    button:hover { opacity: .92; }
    button:active { transform: translateY(1px); }
    .actionBtn { padding: 10px 12px; font-weight: 800; white-space: nowrap; }

    .grid { display: grid; gap: 10px; margin-top: 12px; }
    @media (max-width: 520px){
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 521px) and (max-width: 860px){
      .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (min-width: 861px){
      .grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    .typeBtn{
      padding: 16px 10px;
      min-height: 56px;
      font-size: 16px;
      font-weight: 800;
      line-height: 1.1;
      text-align: center;
    }

    /* ãƒœã‚¿ãƒ³è‰²ï¼ˆå¤§åˆ†é¡ï¼‰ */
    .btn-asset { background: var(--asset-bg); border-color: var(--asset-bd); }
    .btn-liab  { background: var(--liab-bg);  border-color: var(--liab-bd);  }
    .btn-equity{ background: var(--equity-bg);border-color: var(--equity-bd);}
    .btn-exp   { background: var(--exp-bg);   border-color: var(--exp-bd);   }
    .btn-rev   { background: var(--rev-bg);   border-color: var(--rev-bd);   }
    .btn-other { background: var(--other-bg); border-color: var(--other-bd); }

    .summary { margin-top: 10px; display:flex; flex-wrap:wrap; gap:10px 16px; align-items:center; }
    .legend { display:flex; flex-wrap:wrap; gap:8px; margin-top: 8px; }
    .tag { font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); }
    .tag.asset { background: var(--asset-bg); border-color: var(--asset-bd); }
    .tag.liab  { background: var(--liab-bg);  border-color: var(--liab-bd); }
    .tag.equity{ background: var(--equity-bg);border-color: var(--equity-bd);}
    .tag.exp   { background: var(--exp-bg);   border-color: var(--exp-bd); }
    .tag.rev   { background: var(--rev-bg);   border-color: var(--rev-bd); }
    .tag.other { background: var(--other-bg); border-color: var(--other-bd); }

    /* æ­£è§£/ä¸æ­£è§£ã‚’å¤§ãã */
    #result { font-size: 22px; font-weight: 800; margin-top: 10px; }
    #result .ok, #result .ng { font-size: 30px; }

    /* 20å•çµ‚äº†ç”»é¢ */
    #stageClear { display:none; text-align:center; padding: 24px 0; }
    #stageClear .title { font-size: 40px; font-weight: 1000; margin: 16px 0; }
    #stageClear .sub { font-size: 18px; margin: 8px 0 14px; }
    #stageClear .btn { font-size: 18px; padding: 14px 28px; border-radius: 16px; font-weight: 900; }
    #stageClear .stats { margin-top: 12px; font-size: 14px; color: var(--text-muted); }
  </style>
</head>

<body>
  <h2>å‹˜å®šç§‘ç›® åˆ†é¡ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆCSVãã®ã¾ã¾ãƒ»å¤‰æ›ãªã— / BSãƒ»PLçµã‚Šè¾¼ã¿ / 20å•çµ‚äº†ç”»é¢ï¼‰</h2>
ã€€ã€€<b>å‡ºé¡Œã«ä½¿ã†å‹˜å®šç§‘ç›®ã¯æœ€å¤§20å€‹</b>ã€‚
    20å•çµ‚ã‚ã‚‹ã¨çµ‚äº†ç”»é¢ â†’ ãƒœã‚¿ãƒ³ã§2å‘¨ç›®ã«å…¥ã‚Šã¾ã™ã€‚
  </p>

  <div class="card">
    <div class="muted">æ¬¡ã®å‹˜å®šç§‘ç›®ã®ã€Œã‚¿ã‚¤ãƒ—ã€ã¯ï¼Ÿ</div>

    <!-- é€šå¸¸ã®å‡ºé¡Œè¡¨ç¤º -->
    <div id="account" class="big">èª­ã¿è¾¼ã¿ä¸­â€¦</div>

    <!-- â˜… 20å•çµ‚äº†ç”»é¢ï¼ˆã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šcardã®ä¸­ã«ç½®ãï¼‰ -->
    <div id="stageClear">
      <div class="title">ğŸ‰ 20å•ã‚¯ãƒªã‚¢ï¼</div>
      <div id="lapMsg" class="sub"></div>
      <button class="btn" onclick="startNextLap()">æ¬¡ã®20å•ã¸ â–¶</button>
      <div class="stats">
        ã„ã¾ã®æˆç¸¾ï¼šæ­£è§£ <span id="scCorrect">0</span> / å›ç­” <span id="scCount">0</span>ï¼ˆæ­£ç­”ç‡ <span id="scRate">0</span>%ï¼‰
      </div>
    </div>

    <div class="toolbar">
      <label class="small">
        <input id="toggleOther" type="checkbox" checked>
        ã€Œãã®ä»–ã€ã‚‚å‡ºé¡Œã«å«ã‚ã‚‹
      </label>

      <label class="small">
        å‡ºé¡Œçµã‚Šè¾¼ã¿ï¼š
        <select id="typeFilter">
          <option value="__ALL__">ã™ã¹ã¦</option>
        </select>
      </label>

      <button class="actionBtn" onclick="next()">æ¬¡ã¸</button>
      <button class="actionBtn" onclick="resetScore()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="legend">
      <span class="tag asset">è³‡ç”£</span>
      <span class="tag liab">è² å‚µ</span>
      <span class="tag equity">ç´”è³‡ç”£</span>
      <span class="tag exp">è²»ç”¨</span>
      <span class="tag rev">åç›Š</span>
      <span class="tag other">ãã®ä»–</span>
    </div>

    <div id="buttons" class="grid"></div>

    <p id="result" class="muted"></p>

    <div class="summary muted">
      <span>å›ç­”æ•°ï¼š<span id="count">0</span></span>
      <span>æ­£è§£æ•°ï¼š<span id="correct">0</span></span>
      <span>æ­£ç­”ç‡ï¼š<span id="rate">0</span>%</span>
      <span class="small">
        ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼š<span id="total">0</span> /
        å‡ºé¡Œã«ä½¿ç”¨ï¼š<span id="used">0</span> /
        ã‚¿ã‚¤ãƒ—æ•°ï¼š<span id="typeCount">0</span> /
        å‘¨å›ï¼š<span id="lap">0</span> /
        æ®‹ã‚Šï¼š<span id="remain">0</span>ï¼‰
      </span>
    </div>

    <p id="hint" class="small"></p>
  </div>

<script>
  const CSV_PATH = './accounts.csv';
  const MAX_QUESTIONS = 20;

  // ãƒœã‚¿ãƒ³ã®ä¸¦ã³é †
  const TYPE_ORDER = [
    'æµå‹•è³‡ç”£',
    'å›ºå®šè³‡ç”£',
    'æµå‹•è² å‚µ',
    'å›ºå®šè² å‚µ',
    'ç´”è³‡ç”£',
    'å–¶æ¥­è²»ç”¨',
    'è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»',
    'å–¶æ¥­å¤–è²»ç”¨',
    'ç‰¹åˆ¥æå¤±',
    'å–¶æ¥­åç›Š',
    'å–¶æ¥­å¤–åç›Š',
    'ç‰¹åˆ¥åˆ©ç›Š',
    'ãã®ä»–'
  ];

  // è‰²åˆ†ã‘ï¼ˆåˆ¤å®šã¯å¤‰æ›ã—ãªã„ï¼‰
  const TYPE_TO_GROUP = new Map([
    ['æµå‹•è³‡ç”£','asset'], ['å›ºå®šè³‡ç”£','asset'],
    ['æµå‹•è² å‚µ','liab'],  ['å›ºå®šè² å‚µ','liab'],
    ['ç´”è³‡ç”£','equity'],
    ['å–¶æ¥­è²»ç”¨','exp'], ['è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»','exp'], ['å–¶æ¥­å¤–è²»ç”¨','exp'], ['ç‰¹åˆ¥æå¤±','exp'],
    ['å–¶æ¥­åç›Š','rev'], ['å–¶æ¥­å¤–åç›Š','rev'], ['ç‰¹åˆ¥åˆ©ç›Š','rev'],
    ['ãã®ä»–','other'],
  ]);
  const GROUP_TO_BTNCLASS = {
    asset: 'btn-asset', liab: 'btn-liab', equity:'btn-equity',
    exp: 'btn-exp', rev: 'btn-rev', other:'btn-other',
  };

  // BS/PL
  const BS_TYPES = new Set(['æµå‹•è³‡ç”£','å›ºå®šè³‡ç”£','æµå‹•è² å‚µ','å›ºå®šè² å‚µ','ç´”è³‡ç”£']);
  const PL_TYPES = new Set(['å–¶æ¥­è²»ç”¨','è²©å£²è²»ãŠã‚ˆã³ä¸€èˆ¬ç®¡ç†è²»','å–¶æ¥­å¤–è²»ç”¨','ç‰¹åˆ¥æå¤±','å–¶æ¥­åç›Š','å–¶æ¥­å¤–åç›Š','ç‰¹åˆ¥åˆ©ç›Š']);

  // çŠ¶æ…‹
  let allItems = [];   // å…¨ãƒ‡ãƒ¼ã‚¿ {name, type}
  let items = [];      // ãƒ•ã‚£ãƒ«ã‚¿å¾Œï¼ˆæœ€å¤§20ï¼‰
  let types = [];      // typeä¸€è¦§
  let current = null;
  let answered = false;

  let count = 0;
  let correct = 0;

  // å±±æœ­
  let deck = [];
  let deckIndex = 0;
  let lap = 0;

  function normalizeType(s){
    return String(s ?? '').replace(/\s+/g,' ').trim();
  }

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function sortTypesWithOrder(typeList){
    const orderIndex = new Map(TYPE_ORDER.map((t,i)=>[t,i]));
    return [...typeList].sort((a,b)=>{
      const ai = orderIndex.has(a) ? orderIndex.get(a) : 9999;
      const bi = orderIndex.has(b) ? orderIndex.get(b) : 9999;
      if (ai !== bi) return ai - bi;
      return a.localeCompare(b, 'ja');
    });
  }

  function updateRemain(){
    const remain = Math.max(0, deck.length - deckIndex);
    document.getElementById('remain').textContent = String(remain);
    document.getElementById('used').textContent = String(deck.length);
  }

  function showQuizUI(){
    document.getElementById("stageClear").style.display = "none";
    document.getElementById("account").style.display = "block";
    document.getElementById("buttons").style.display = "grid";
  }

  function showClearUI(){
    document.getElementById("account").style.display = "none";
    document.getElementById("buttons").style.display = "none";
    document.getElementById("stageClear").style.display = "block";

    // çµ‚äº†ç”»é¢ã«æˆç¸¾ã‚’è¡¨ç¤º
    document.getElementById("scCorrect").textContent = String(correct);
    document.getElementById("scCount").textContent = String(count);
    const rate = count === 0 ? 0 : Math.round((correct / count) * 100);
    document.getElementById("scRate").textContent = String(rate);

    document.getElementById("lapMsg").textContent =
      `${lap}å‘¨ç›®ãŒçµ‚äº†ã—ã¾ã—ãŸï¼ˆ${deck.length}å•ï¼‰`;
  }

  function prepareDeck(){
    deck = [...items];
    shuffle(deck);
    deckIndex = 0;
    lap += 1;
    document.getElementById('lap').textContent = String(lap);
    updateRemain();
  }

  function startNextLap(){
    // 2å‘¨ç›®ã¸ï¼ˆåŒã˜20å•ã‚’å†ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
    showQuizUI();
    document.getElementById("result").textContent = "";
    prepareDeck();
    next();
  }

  function allowByFilter(xType, filterType){
    if (filterType === '__ALL__') return true;
    if (filterType === '__BS__') return BS_TYPES.has(xType);
    if (filterType === '__PL__') return PL_TYPES.has(xType);
    if (filterType === '__OTHER__') return xType === 'ãã®ä»–';
    return xType === filterType;
  }

  function renderScore(){
    document.getElementById("count").textContent = count;
    document.getElementById("correct").textContent = correct;
    const rate = count === 0 ? 0 : Math.round((correct / count) * 100);
    document.getElementById("rate").textContent = rate;
  }

  function show(item){
    current = item;
    answered = false;
    document.getElementById("account").textContent = item ? item.name : "â€”";
    document.getElementById("result").textContent = "";
  }

  function answer(type){
    if (!current || answered) return;
    answered = true;
    count++;

    const ok = (type === current.type);
    if (ok) correct++;

    document.getElementById("result").innerHTML =
      ok
        ? `<span class="ok">æ­£è§£ï¼</span>ï¼ˆ${current.name} â†’ ${current.type}ï¼‰`
        : `<span class="ng">ä¸æ­£è§£</span>ï¼ˆã‚ãªãŸï¼š${type} / æ­£è§£ï¼š${current.type}ï¼‰`;

    renderScore();
  }

  // â˜… ã“ã“ãŒã€Œ20å•çµ‚ã‚ã£ãŸã‚‰çµ‚äº†ç”»é¢ã€æœ¬ä½“
  function next(){
    if (!deck.length) return;

    // 20å•ã™ã¹ã¦å‡ºã—çµ‚ãˆãŸã‚‰çµ‚äº†ç”»é¢ã¸ï¼ˆè‡ªå‹•ã§2å‘¨ç›®ã«å…¥ã‚‰ãªã„ï¼‰
    if (deckIndex >= deck.length) {
      showClearUI();
      return;
    }

    show(deck[deckIndex]);
    deckIndex++;
    updateRemain();
  }

  function resetScore(){
    count = 0;
    correct = 0;
    renderScore();

    lap = 0;
    document.getElementById('lap').textContent = "0";

    // 20å•ã‚’å†æŠ½é¸ï¼ˆãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã¯ç¶­æŒï¼‰
    applyFiltersAndReady();
  }

  function buildButtons(typeList){
    const wrap = document.getElementById('buttons');
    wrap.innerHTML = '';
    typeList.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'typeBtn';
      const grp = TYPE_TO_GROUP.get(t) || 'other';
      btn.classList.add(GROUP_TO_BTNCLASS[grp] || 'btn-other');
      btn.textContent = t;
      btn.onclick = () => answer(t);
      wrap.appendChild(btn);
    });
  }

  function buildTypeFilter(typeList){
    const sel = document.getElementById('typeFilter');
    const cur = sel.value;
    sel.innerHTML = '';

    const topOptions = [
      { label: 'ã™ã¹ã¦', value: '__ALL__' },
      { label: 'è²¸å€Ÿå¯¾ç…§è¡¨ï¼ˆBSï¼‰', value: '__BS__' },
      { label: 'æç›Šè¨ˆç®—æ›¸ï¼ˆPLï¼‰', value: '__PL__' },
      { label: 'ãã®ä»–ã®ã¿', value: '__OTHER__' },
    ];
    for (const o of topOptions) {
      const opt = document.createElement('option');
      opt.textContent = o.label;
      opt.value = o.value;
      sel.appendChild(opt);
    }

    const sep = document.createElement('option');
    sep.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€';
    sep.value = '__SEP__';
    sep.disabled = true;
    sel.appendChild(sep);

    for (const t of typeList) {
      const opt = document.createElement('option');
      opt.textContent = t;
      opt.value = t;
      sel.appendChild(opt);
    }

    const allowedVals = new Set(['__ALL__','__BS__','__PL__','__OTHER__', ...typeList]);
    sel.value = allowedVals.has(cur) ? cur : '__ALL__';

    sel.onchange = () => {
      if (sel.value === '__SEP__') sel.value = '__ALL__';
      applyFiltersAndReady();
    };
    document.getElementById('toggleOther').onchange = () => applyFiltersAndReady();
  }

  function applyFiltersAndReady(){
    showQuizUI();

    const includeOther = document.getElementById('toggleOther').checked;
    const filterType = document.getElementById('typeFilter').value;

    // 1) æ¡ä»¶ã§çµã‚‹
    let filtered = allItems.filter(x => {
      if (!includeOther && x.type === 'ãã®ä»–') return false;
      if (!allowByFilter(x.type, filterType)) return false;
      return true;
    });

    if (!filtered.length){
      deck = []; deckIndex = 0; lap = 0;
      document.getElementById('lap').textContent = "0";
      document.getElementById('account').style.display = "block";
      document.getElementById('account').textContent = 'å‡ºé¡Œã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶';
      document.getElementById('result').innerHTML = `<span class="warn">æ¡ä»¶ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚</span>`;
      document.getElementById('used').textContent = "0";
      document.getElementById('remain').textContent = "0";
      return;
    }

    // 2) æœ€å¤§20ä»¶ã«åˆ¶é™ï¼ˆæ¯å›ãƒ©ãƒ³ãƒ€ãƒ æŠ½é¸ï¼‰
    if (filtered.length > MAX_QUESTIONS) {
      const tmp = [...filtered];
      shuffle(tmp);
      filtered = tmp.slice(0, MAX_QUESTIONS);
    }

    items = filtered;

    // 3) å±±æœ­æº–å‚™ï¼ˆ1å‘¨ç›®é–‹å§‹ï¼‰
    lap = 0;
    document.getElementById('lap').textContent = "0";
    prepareDeck(); // lapãŒ1ã«ãªã‚‹
    next();
  }

  async function loadCSV() {
    const res = await fetch(CSV_PATH, { cache: 'no-store' });
    if (!res.ok) throw new Error(`accounts.csv ãŒèª­ã‚ã¾ã›ã‚“ï¼ˆ${CSV_PATH}ï¼‰ã€‚åŒã˜éšå±¤ã«ç½®ã‘ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);

    const text = await res.text();
    const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
    if (lines.length < 2) throw new Error('CSVã«ãƒ‡ãƒ¼ã‚¿è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆè¦‹å‡ºã—ï¼‹1è¡Œä»¥ä¸Šå¿…è¦ï¼‰ã€‚');

    const header = lines.shift().split(',').map(s => s.trim());
    const idxAccount = header.indexOf('account');
    const idxType = header.indexOf('type');
    if (idxAccount === -1 || idxType === -1) {
      throw new Error('CSVã®1è¡Œç›®ï¼ˆè¦‹å‡ºã—ï¼‰ã¯ã€Œaccount,typeã€ã«ã—ã¦ãã ã•ã„ã€‚');
    }

    const parsed = [];
    for (const line of lines) {
      const cols = line.split(',').map(s => s.trim());
      const name = cols[idxAccount];
      const rawType = cols[idxType];
      if (!name || !rawType) continue;
      parsed.push({ name, type: normalizeType(rawType) });
    }
    if (!parsed.length) throw new Error('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã§ã—ãŸã€‚');

    allItems = parsed;

    const set = new Set(parsed.map(x => x.type));
    types = sortTypesWithOrder(Array.from(set));

    document.getElementById('total').textContent = String(allItems.length);
    document.getElementById('typeCount').textContent = String(types.length);

    buildTypeFilter(types);
    buildButtons(types);

    document.getElementById('hint').textContent =
      `èª­ã¿è¾¼ã¿OKï¼š${allItems.length}ä»¶ / ã‚¿ã‚¤ãƒ—ï¼š${types.length}ç¨®ã€‚`;

    applyFiltersAndReady();
  }

  async function reload(){
    showQuizUI();
    document.getElementById("account").textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
    document.getElementById("result").textContent = "";
    document.getElementById("hint").textContent = "";
    document.getElementById("buttons").innerHTML = "";
    document.getElementById("typeFilter").innerHTML = `<option value="__ALL__">ã™ã¹ã¦</option>`;
    document.getElementById('total').textContent = "0";
    document.getElementById('typeCount').textContent = "0";
    document.getElementById('lap').textContent = "0";
    document.getElementById('used').textContent = "0";
    document.getElementById('remain').textContent = "0";

    allItems = [];
    items = [];
    types = [];
    current = null;
    answered = false;

    deck = [];
    deckIndex = 0;
    lap = 0;

    count = 0;
    correct = 0;
    renderScore();

    try{
      await loadCSV();
    } catch(e){
      document.getElementById("account").style.display = "block";
      document.getElementById("account").textContent = "CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
      document.getElementById("result").innerHTML =
        `<span class="warn">ã‚¨ãƒ©ãƒ¼ï¼š</span>${String(e.message).replace(/\n/g,'<br>')}`;
    }
  }

  (async function init(){
    await reload();
  })();
</script>
</body>
</html>






